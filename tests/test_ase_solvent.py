import numpy as np
import pytest
from ase.atoms import Atoms

from pygfnxtb.ase import XTB


def test_gfn2_xtb_0d():
    """Test ASE interface to GFN2-xTB."""
    thr = 5.0e-4

    atoms = Atoms(
        symbols="CHOCH2CH4CH2OH",
        positions=np.array(
            [
                [1.578385, 0.147690, 0.343809],
                [1.394750, 0.012968, 1.413545],
                [1.359929, -1.086203, -0.359782],
                [0.653845, 1.215099, -0.221322],
                [1.057827, 2.180283, 0.093924],
                [0.729693, 1.184864, -1.311438],
                [-0.817334, 1.152127, 0.208156],
                [-1.303525, 2.065738, -0.145828],
                [-0.883765, 1.159762, 1.299260],
                [1.984120, -1.734446, -0.021385],
                [2.616286, 0.458948, 0.206544],
                [-1.627725, -0.034052, -0.311301],
                [-2.684229, 0.151015, -0.118566],
                [-1.501868, -0.118146, -1.397506],
                [-1.324262, -1.260154, 0.333377],
                [-0.417651, -1.475314, 0.076637],
            ]
        ),
    )
    forces = np.array(
        [
            [-0.28561158, -0.48592026, -0.28392327],
            [-0.05526158, -0.07403455, 0.09665539],
            [0.18824950, 0.39170140, 0.33881928],
            [-0.01166074, 0.24653252, -0.16779606],
            [-0.05367503, 0.03368063, 0.05115422],
            [-0.09605262, -0.10000389, 0.01097286],
            [0.09423300, 0.18573616, 0.17797438],
            [0.02651896, -0.04073849, -0.03655980],
            [0.07886359, -0.05806479, 0.00649360],
            [-0.00780520, -0.07979390, -0.03175697],
            [0.13328595, 0.03209283, -0.04638514],
            [0.08197778, -0.39157299, 0.12107401],
            [-0.11453823, -0.01485088, 0.09974068],
            [0.09786017, -0.09130861, -0.05738675],
            [-0.26643400, 0.47603727, -0.27856705],
            [0.19005003, -0.02949244, -0.00050938],
        ]
    )
    e_nosol, e_sol = -592.6794366990786, -592.9940608761889

    atoms.calc = XTB(method="GFN2-xTB")
    assert pytest.approx(atoms.get_forces(), abs=thr) == forces
    assert pytest.approx(atoms.get_potential_energy(), abs=thr) == e_nosol

    atoms.calc = XTB(
        method="GFN2-xTB",
        accuracy=0.1,
        electronic_temperature=500.0,
        max_iterations=20,
        solvent="ch2cl2",
    )
    assert pytest.approx(atoms.get_potential_energy(), abs=thr) == e_sol


def test_gfn1_xtb_0d():
    """Test ASE interface to GFN1-xTB."""
    thr = 1.0e-4

    atoms = Atoms(
        symbols="CHOCH2CH4CH2OH",
        positions=np.array(
            [
                [1.578385, 0.147690, 0.343809],
                [1.394750, 0.012968, 1.413545],
                [1.359929, -1.086203, -0.359782],
                [0.653845, 1.215099, -0.221322],
                [1.057827, 2.180283, 0.093924],
                [0.729693, 1.184864, -1.311438],
                [-0.817334, 1.152127, 0.208156],
                [-1.303525, 2.065738, -0.145828],
                [-0.883765, 1.159762, 1.299260],
                [1.984120, -1.734446, -0.021385],
                [2.616286, 0.458948, 0.206544],
                [-1.627725, -0.034052, -0.311301],
                [-2.684229, 0.151015, -0.118566],
                [-1.501868, -0.118146, -1.397506],
                [-1.324262, -1.260154, 0.333377],
                [-0.417651, -1.475314, 0.076637],
            ]
        ),
    )
    forces = np.array(
        [
            [-0.37070590, -0.51067739, -0.27981764],
            [-0.04339461, -0.09290876, 0.22940156],
            [0.11141234, 0.46678720, 0.24552625],
            [0.04255709, 0.19019316, -0.23531997],
            [-0.01897377, 0.10810803, 0.05314982],
            [-0.07150720, -0.05182148, -0.08413638],
            [0.06631826, 0.10587709, 0.29833479],
            [-0.01062355, 0.02301460, -0.04964730],
            [0.06610108, -0.02724994, 0.09234280],
            [0.06519070, -0.19311773, -0.01152205],
            [0.23879786, 0.09871398, -0.04009526],
            [-0.04381577, -0.49997745, 0.08672818],
            [-0.23259608, 0.13735636, 0.06783414],
            [0.08297636, -0.09566973, -0.20602954],
            [-0.23686052, 0.57454371, -0.17194215],
            [0.35512370, -0.23317164, 0.00519275],
        ]
    )

    atoms.calc = XTB(method="GFN1-xTB")

    assert (
        pytest.approx(atoms.get_potential_energy(), abs=thr)
        == -632.7363734598027
    )
    assert pytest.approx(atoms.get_forces(), abs=thr) == forces
